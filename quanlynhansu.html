<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Employee Tracking</title>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #map { height: 60vh; width: 100%; }
    .container { padding: 1rem; }
    input, button { padding: 0.5rem; margin: 0.25rem 0; }
    .info { margin-top: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Nh·∫≠p m√£ c√¥ng vi·ªác</h2>
    <input type="text" id="jobCode" placeholder="VD: ABC123" />
    <button onclick="fetchJobInfo()">Xem c√¥ng vi·ªác</button>

    <div id="jobInfo" class="info"></div>
    <div id="joinSection" class="info" style="display:none;">
      <button onclick="joinJob()">Tham gia</button>
    </div>
  </div>

  <div id="map"></div>

  <script>
    let map;
    let userMarker;
    let jobMarker;
    let joined = false;
    let job = null;
    const sheetURL = 'https://opensheet.elk.sh/14hpn7reiKVO4lwBHPRST1N6ZgtCrMg4UWEe_D2QDV9k/CongViec';

    function initMap(lat = 21.0278, lng = 105.8342) {
      map = L.map('map').setView([lat, lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
      }).addTo(map);
    }

    function fetchJobInfo() {
      const code = document.getElementById('jobCode').value.trim();
      axios.get(sheetURL).then(res => {
        const jobs = res.data;
        const found = jobs.find(j => j['M√£ c√¥ng vi·ªác'] === code);
        if (found) {
          job = {
            code: found['M√£ c√¥ng vi·ªác'],
            location: found['V·ªã tr√≠'],
            checkinTime: found['Th·ªùi gian c√≥ m·∫∑t'],
            startTime: found['Th·ªùi gian b·∫Øt ƒë·∫ßu ƒëi·ªÉm danh']
          };
          document.getElementById('jobInfo').innerHTML = `
            <strong>V·ªã tr√≠:</strong> ${job.location}<br>
            <strong>Th·ªùi gian c√≥ m·∫∑t:</strong> ${job.checkinTime}<br>
            <strong>B·∫Øt ƒë·∫ßu ƒëi·ªÉm danh:</strong> ${job.startTime}`;
          document.getElementById('joinSection').style.display = 'block';
        } else {
          document.getElementById('jobInfo').innerText = 'Kh√¥ng t√¨m th·∫•y m√£ c√¥ng vi·ªác.';
          document.getElementById('joinSection').style.display = 'none';
        }
      });
    }

    function joinJob() {
      joined = true;
      alert('ƒê√£ tham gia c√¥ng vi·ªác. Vui l√≤ng kh√¥ng t·∫Øt tab.');
      startLocationTracking();
    }

    function startLocationTracking() {
      if (!navigator.geolocation) {
        alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.');
        return;
      }

      const jobCoords = job.location.split(',').map(coord => parseFloat(coord.trim()));

      // Hi·ªán marker c√¥ng vi·ªác
      jobMarker = L.marker(jobCoords, {
        icon: L.icon({
          iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
          iconSize: [32, 32]
        })
      }).addTo(map).bindPopup('üìç V·ªã tr√≠ c√¥ng vi·ªác');

      // Theo d√µi v·ªã tr√≠ ng∆∞·ªùi d√πng
      setInterval(() => {
        if (!joined) return;
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;

          if (!userMarker) {
            userMarker = L.marker([latitude, longitude]).addTo(map).bindPopup('üìç B·∫°n ƒëang ·ªü ƒë√¢y');
          } else {
            userMarker.setLatLng([latitude, longitude]);
          }

          // Canh gi·ªØa b·∫£n ƒë·ªì gi·ªØa b·∫°n v√† c√¥ng vi·ªác
          const centerLat = (latitude + jobCoords[0]) / 2;
          const centerLng = (longitude + jobCoords[1]) / 2;
          map.setView([centerLat, centerLng], 14);

          console.log('ƒê√£ c·∫≠p nh·∫≠t v·ªã tr√≠:', latitude, longitude);
        });
      }, 10000); // m·ªói 10 gi√¢y
    }

    initMap();
  </script>
</body>
</html>
