<script>
    const firebaseConfig = {
        apiKey: "AIzaSyACcXy76y8N5XpR-73IBRNHMneNbv2oz9k",
        authDomain: "anniezwedding-be1a8.firebaseapp.com",
        databaseURL: "https://anniezwedding-be1a8-default-rtdb.firebaseio.com/",
        projectId: "anniezwedding-be1a8",
        storageBucket: "anniezwedding-be1a8.appspot.com",
        messagingSenderId: "792848269559",
        appId: "1:792848269559:web:6b2b6a2ec9a942ce6613f2",
        measurementId: "G-DT55Y6LJY7"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let jobs = {};
    let currentJob = null;
    let currentUser = "";
    let map;

    // 🔹 Load dữ liệu từ Firebase trước khi sử dụng
    database.ref("jobs").once("value").then(snapshot => {
        jobs = snapshot.val() || {};  // Nếu không có dữ liệu, gán một object rỗng
        console.log("Dữ liệu công việc từ Firebase:", jobs);
    }).catch(error => {
        console.error("Lỗi khi tải dữ liệu Firebase:", error);
    });

    function checkJobCode() {
        const code = document.getElementById("jobCodeInput").value;

        // Kiểm tra nếu dữ liệu chưa tải xong
        if (Object.keys(jobs).length === 0) {
            alert("Dữ liệu công việc chưa tải xong, vui lòng thử lại!");
            return;
        }

        if (code === "an1122") {
            document.getElementById("adminSection").style.display = "block";
            return;
        }

        if (jobs[code]) {
            currentJob = code;
            document.getElementById("jobInfo").innerText = `Thời gian: ${jobs[code].time}\nĐịa điểm: ${jobs[code].location}`;
            document.getElementById("jobInputSection").style.display = "none";
            document.getElementById("jobDetailSection").style.display = "block";
        } else {
            alert("Mã công việc không hợp lệ!");
        }
    }

    function joinJob() {
        if (!currentJob) return;

        const userName = document.getElementById("userNameInput").value;
        if (!userName) {
            alert("Vui lòng nhập tên của bạn!");
            return;
        }

        currentUser = userName;

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    name: userName
                };

                database.ref(`jobs/${currentJob}/participants`).push(userLocation)
                    .then(() => {
                        alert("Bạn đã tham gia công việc thành công!");
                    })
                    .catch(error => {
                        console.error("Lỗi khi lưu vị trí:", error);
                    });
            }, () => {
                alert("Không thể lấy vị trí của bạn!");
            });
        } else {
            alert("Trình duyệt không hỗ trợ định vị!");
        }
    }

    function getAllParticipants() {
        const code = document.getElementById("adminJobCode").value;
        if (!jobs[code]) {
            alert("Mã công việc không hợp lệ!");
            return;
        }

        if (!map) {
            map = L.map('map').setView([jobs[code].coords.lat, jobs[code].coords.lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
                map.removeLayer(layer);
            }
        });

        L.marker([jobs[code].coords.lat, jobs[code].coords.lng]).addTo(map)
            .bindPopup("Vị trí công việc").openPopup();

        database.ref(`jobs/${code}/participants`).once("value", snapshot => {
            snapshot.forEach(childSnapshot => {
                const participant = childSnapshot.val();
                L.marker([participant.lat, participant.lng]).addTo(map)
                    .bindPopup(`${participant.name}`).openPopup();
            });
        });

        document.getElementById("map").style.display = "block";
    }
</script>
