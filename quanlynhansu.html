<script>
    const firebaseConfig = {
        apiKey: "AIzaSyACcXy76y8N5XpR-73IBRNHMneNbv2oz9k",
        authDomain: "anniezwedding-be1a8.firebaseapp.com",
        databaseURL: "https://anniezwedding-be1a8-default-rtdb.firebaseio.com/",
        projectId: "anniezwedding-be1a8",
        storageBucket: "anniezwedding-be1a8.appspot.com",
        messagingSenderId: "792848269559",
        appId: "1:792848269559:web:6b2b6a2ec9a942ce6613f2",
        measurementId: "G-DT55Y6LJY7"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let jobs = {};
    let currentJob = null;
    let currentUser = "";
    let map;

    // ðŸ”¹ Load dá»¯ liá»‡u tá»« Firebase trÆ°á»›c khi sá»­ dá»¥ng
    database.ref("jobs").once("value").then(snapshot => {
        jobs = snapshot.val() || {};  // Náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u, gÃ¡n má»™t object rá»—ng
        console.log("Dá»¯ liá»‡u cÃ´ng viá»‡c tá»« Firebase:", jobs);
    }).catch(error => {
        console.error("Lá»—i khi táº£i dá»¯ liá»‡u Firebase:", error);
    });

    function checkJobCode() {
        const code = document.getElementById("jobCodeInput").value;

        // Kiá»ƒm tra náº¿u dá»¯ liá»‡u chÆ°a táº£i xong
        if (Object.keys(jobs).length === 0) {
            alert("Dá»¯ liá»‡u cÃ´ng viá»‡c chÆ°a táº£i xong, vui lÃ²ng thá»­ láº¡i!");
            return;
        }

        if (code === "an1122") {
            document.getElementById("adminSection").style.display = "block";
            return;
        }

        if (jobs[code]) {
            currentJob = code;
            document.getElementById("jobInfo").innerText = `Thá»i gian: ${jobs[code].time}\nÄá»‹a Ä‘iá»ƒm: ${jobs[code].location}`;
            document.getElementById("jobInputSection").style.display = "none";
            document.getElementById("jobDetailSection").style.display = "block";
        } else {
            alert("MÃ£ cÃ´ng viá»‡c khÃ´ng há»£p lá»‡!");
        }
    }

    function joinJob() {
        if (!currentJob) return;

        const userName = document.getElementById("userNameInput").value;
        if (!userName) {
            alert("Vui lÃ²ng nháº­p tÃªn cá»§a báº¡n!");
            return;
        }

        currentUser = userName;

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    name: userName
                };

                database.ref(`jobs/${currentJob}/participants`).push(userLocation)
                    .then(() => {
                        alert("Báº¡n Ä‘Ã£ tham gia cÃ´ng viá»‡c thÃ nh cÃ´ng!");
                    })
                    .catch(error => {
                        console.error("Lá»—i khi lÆ°u vá»‹ trÃ­:", error);
                    });
            }, () => {
                alert("KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­ cá»§a báº¡n!");
            });
        } else {
            alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ Ä‘á»‹nh vá»‹!");
        }
    }

    function getAllParticipants() {
        const code = document.getElementById("adminJobCode").value;
        if (!jobs[code]) {
            alert("MÃ£ cÃ´ng viá»‡c khÃ´ng há»£p lá»‡!");
            return;
        }

        if (!map) {
            map = L.map('map').setView([jobs[code].coords.lat, jobs[code].coords.lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
                map.removeLayer(layer);
            }
        });

        L.marker([jobs[code].coords.lat, jobs[code].coords.lng]).addTo(map)
            .bindPopup("Vá»‹ trÃ­ cÃ´ng viá»‡c").openPopup();

        database.ref(`jobs/${code}/participants`).once("value", snapshot => {
            snapshot.forEach(childSnapshot => {
                const participant = childSnapshot.val();
                L.marker([participant.lat, participant.lng]).addTo(map)
                    .bindPopup(`${participant.name}`).openPopup();
            });
        });

        document.getElementById("map").style.display = "block";
    }
</script>
